# Feedback App

This project implements a feedback application allowing the user to
1. Import a CSV file containing feedback from Feedier on an hourly basis through a CRON job
2. Create a feedback entry through a form
3. Export all feedback as a JSON file and send it to all the admin users every Friday at 3pm, through a CRON job
4. Import feedback manually with a JSON or CSV file if logged in

## Getting Started

### Installation

1. Clone the repository:

    ```bash
    git clone git@github.com:tamglaeser/feedbackapp.git
    ```

2. Navigate to the project directory:

    ```bash
    cd feedbackapp
    ```

3. Install PHP dependencies:

    ```bash
    composer install
    ```

4. Install Node.js dependencies:

    ```bash
    npm install
    ```

5. Generate application key:

    ```bash
    php artisan key:generate
    ```

6. Compile assets:

    ```bash
    npm run dev
    ```

### Usage

To start the development server, run:

```bash
php artisan serve
```
 You can now open http://localhost:8000 to see the application.

### Project Structure
````bash
feedbackapp/
│
├── app/               # Contains core application code (controllers, models, etc.)
│   ├── Console/       # Artisan console commands
│   │   ├── Commands/  # Contains implementation of my two CRON commands
│   │   ├── Kernel.php # Contains scheduler of CRON commands
│   ├── Exceptions/    # Exception handling
│   ├── Http/          # Controllers, middleware, requests
│   ├── Mail/          # Mailables
│   ├── Models/        # ie. Feedback, User
│   ├── Providers/     # Service providers
│   └── Services/      
│
├── bootstrap/         # Bootstrapping and application startup
│   └── ...            # Framework initialization files
│
├── config/            # Configuration files for various application components
│   └── ...            # Files such as database, services, app settings, etc.
│
├── database/          # Database-related files
│   ├── migrations/    # Database migration files to create / modify tables
│   └── seeds/         # Database seeders
│
├── public/            # Publicly accessible files served by the webserver
│   └── ...            # Assets, index.php, etc.
│
├── resources/         # Views, language files, and frontend assets
│   ├── js/            # Vue components, app.js
│   ├── views/         # Blade templates/views
│   └── ...            # Other assets, such as CSS
│
├── routes/            # Route definitions for the application
│   └── ...            # Web.php, API.php, etc.
│
├── storage/           # Storage for logs, file uploads, and other temporary files
│   ├── app/           # Files generated by the application
│   ├── framework/     # Framework-generated files
│   └── ...            # Other storage-related items
│
├── .env               # Environment-specific configuration file
├── .gitignore         # Files and directories ignored by version control
├── artisan            # Laravel's command-line interface executable
├── composer.json      # Defines PHP dependencies for the Laravel application
├── package.json       # Node.js dependencies and scripts (if present)
└── ...                # Other project-related files and folders

````

## Database

Using SQLite as my database; find under `database/database.sqlite`. See configurations within the `.env` file.

## Mail
Using [Mailtrap](https://mailtrap.io/) as "dummy" mailbox to test my email sending. Configurations can be found in `.env` file; modify the host,
username, password, and other configurations to set up with your own Mailtrap account. Will then be able to see the sent
emails in your Mailtrap inbox, including the To and From addresses, content, and attachments.

## Sentry
Using [Sentry](https://sentry.io/) to capture exceptions or messages as events. Replace `SENTRY_LARAVEL_DSN` (currently 
set to `null`) in the `.env` file to your Sentry Laravel DNS to see the events on your Sentry account.

## CRON Jobs

To set up CRON to call the Laravel command scheduler every minute, running the commands when scheduled, execute
````bash
php artisan schedule:run >> /dev/null 2>&1
````
This will ensure steps 1 and 3 of this application are processed, importing feedback data from Feedier every hour and
sending feedback data to admin users every Friday at 3pm.

To see all available commands provided by Artisan, execute
````bash
php artisan list
````

The two schedule CRON jobs can be found here as commands:
````bash
php artisan csv:process  # Import Feedier CSV file
php artisan export:feedback  # Export feedback as JSON and send it to admin users
````

### Certificate Authority

To set up my certificate for my first CRON job - importing the Feedier CSV file - and avoid an SSL error, I had to 
download the latest cURL bundle of all the CAs (which includes the Amazon one), and add the path of this `cacert.pem`
as my `php.ini` `openssl.cafile` variable. In case the Amazon CA were missing from this file, I could download the 
certificate from the [Feedier Production Site](https://feedier-production.s3.eu-west-1.amazonaws.com/) and add the CA
to the `cacert.pem`.

## Test 2

You receive this error from the product team:
````agsl
Sentry
Illuminate\Queue\MaxAttemptsExceededException
App\Jobs\Feedbacks\ExportFeedbacks has been attempted too many times or run too long. The job may have previously timed out.
````

Based on your understanding of Laravel Queues,
1. Describe in your own words what this error means and the assumptions you can make.
    This error means that the ExportFeedbacks job (supposedly exporting the feedback by email to the admin user at 3pm 
    every Friday) either surpasses the maximum number of attempts allowed or runs for longer than expected. This job 
    could be encountering issues during processing or could simply be taking longer than expected to execute. Perhaps 
    it is accidentally entering an infinite loop or experiencing an error preventing it from completing successfully 
    within the allowed attempts or time frame.
    Assuming the ExportFeedbacks job is responsible for exporting the feedback by email to the admin user every Friday at 
    3pm, perhaps it is failing to reach the email server and not throwing an error, or the feedback data is too large, 
    causing the program to time-out, or the JSON file attached to the email is too large and the email-sending keeps 
    failing, etc. There could be many reasons for this error which is why we would need to debug.
2. What are your 3 actions or workflows you would suggest to solve the issue with your team?
    The first action I would suggest to solve this issue would be to implement logging to see what part of the job is 
    taking the longest, what the values and sizes are, etc. After reading the logs, perhaps we find that certain parts 
    of the job could be optimized, ie. chunking large data sets, optimizing queries, etc. This first action includes 
    examining the code to identify any inefficiencies or reasons for timeouts.

    My second suggested action would be to improve exception handling to capture errors, log them, and respond accordingly.
    We could also send alerts to Sentry to notify the team when a job fails multiple times or exceeds its allotted time.

    Finally, I would suggest modifying the queue configuration for this job, increasing the maximum allowed attempts and 
    time before timeout to allow a longer processing window. Depending on the urgency of this job, this step could be 
    implemented first so as to possibly avoid the lack of an important process, ie. if it is critical for the admin user 
    to get the feedback JSON every Friday, we first increase the processing time / maximum allowed attempts in case this 
    would allow the admin to get their JSON file.
